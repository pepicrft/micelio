name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Install Kamal
        run: gem install kamal

      - name: Set up fnox identity
        run: |
          mkdir -p ~/.config/fnox
          echo "${{ secrets.FNOX_AGE_KEY }}" > ~/.config/fnox/micelio-age.txt
          chmod 600 ~/.config/fnox/micelio-age.txt

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          fnox get SSH_PRIVATE_KEY > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -R 91.98.64.68 2>/dev/null || true
          ssh-keyscan -H 91.98.64.68 >> ~/.ssh/known_hosts

          # Configure SSH to skip strict host key checking for this server
          cat >> ~/.ssh/config << EOF
          Host 91.98.64.68
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Configure buildx for insecure registry
        run: |
          # Clean up any existing builder containers on remote
          ssh root@91.98.64.68 "docker rm -f \$(docker ps -aq --filter name=buildx_buildkit_kamal) 2>/dev/null || true"

          # Create buildkit config locally (will be used when creating remote builder)
          sudo mkdir -p /etc/buildkit
          sudo tee /etc/buildkit/buildkitd.toml > /dev/null << 'EOF'
          [registry."91.98.64.68:5000"]
            http = true
            insecure = true
          EOF

          # Create context and builder on CI runner pointing to remote
          docker context rm kamal-remote-ssh---root-91-98-64-68-context 2>/dev/null || true
          docker context create kamal-remote-ssh---root-91-98-64-68-context --description 'Remote build host' --docker 'host=ssh://root@91.98.64.68'
          docker buildx rm kamal-remote-ssh---root-91-98-64-68 2>/dev/null || true
          docker buildx create --name kamal-remote-ssh---root-91-98-64-68 \
            --driver docker-container \
            --config /etc/buildkit/buildkitd.toml \
            kamal-remote-ssh---root-91-98-64-68-context
          docker buildx use kamal-remote-ssh---root-91-98-64-68
          docker buildx inspect --bootstrap kamal-remote-ssh---root-91-98-64-68

      - name: Deploy with Kamal
        run: |
          # Export secrets from fnox as environment variables for Kamal
          export KAMAL_REGISTRY_PASSWORD=$(fnox get KAMAL_REGISTRY_PASSWORD)
          export SECRET_KEY_BASE=$(fnox get SECRET_KEY_BASE)
          export POSTGRES_PASSWORD=$(fnox get POSTGRES_PASSWORD)
          export SMTP_HOST=$(fnox get SMTP_HOST)
          export SMTP_USERNAME=$(fnox get SMTP_USERNAME)
          export SMTP_PASSWORD=$(fnox get SMTP_PASSWORD)
          export SMTP_PORT=$(fnox get SMTP_PORT)
          export SMTP_FROM_EMAIL=$(fnox get SMTP_FROM_EMAIL)
          export SMTP_FROM_NAME=$(fnox get SMTP_FROM_NAME)
          export S3_BUCKET=$(fnox get S3_BUCKET)
          export S3_ENDPOINT=$(fnox get S3_ENDPOINT)
          export S3_REGION=$(fnox get S3_REGION)
          export AWS_ACCESS_KEY_ID=$(fnox get AWS_ACCESS_KEY_ID)
          export AWS_SECRET_ACCESS_KEY=$(fnox get AWS_SECRET_ACCESS_KEY)

          # Create .kamal/secrets file locally with all required secrets
          mkdir -p .kamal
          cat > .kamal/secrets << EOF
          KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD
          SECRET_KEY_BASE=$SECRET_KEY_BASE
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          SMTP_HOST=$SMTP_HOST
          SMTP_USERNAME=$SMTP_USERNAME
          SMTP_PASSWORD=$SMTP_PASSWORD
          SMTP_PORT=$SMTP_PORT
          SMTP_FROM_EMAIL=$SMTP_FROM_EMAIL
          SMTP_FROM_NAME=$SMTP_FROM_NAME
          S3_BUCKET=$S3_BUCKET
          S3_ENDPOINT=$S3_ENDPOINT
          S3_REGION=$S3_REGION
          AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
          EOF

          # Copy secrets to remote server
          scp .kamal/secrets root@91.98.64.68:.kamal/secrets

          kamal deploy
